name: Cleanup Snapshots

on:
  workflow_dispatch:
    inputs:
      keep_count:
        description: 'Number of recent snapshots to keep'
        required: false
        default: '3'
        type: string
      cleanup_all:
        description: 'Delete all snapshots (keep only official releases)'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  cleanup-snapshots:
    name: Cleanup Snapshot Releases
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cleanup snapshots
        id: cleanup
        uses: ./.github/actions/cleanup-snapshots
        with:
          cleanup-mode: ${{ github.event.inputs.cleanup_all == 'true' && 'all' || 'old-versions' }}
          keep-versions-count: ${{ github.event.inputs.keep_count || '3' }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Show remaining releases
        run: |
          echo ""
          echo "📋 Remaining releases:"
          gh release list --limit 20
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate cleanup summary
        run: |
          KEEP_COUNT="${{ github.event.inputs.keep_count || '3' }}"
          CLEANUP_ALL="${{ github.event.inputs.cleanup_all }}"
          DELETED_COUNT="${{ steps.cleanup.outputs.deleted-count }}"
          KEPT_COUNT="${{ steps.cleanup.outputs.kept-count }}"

          echo "## 🧹 Snapshot Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$CLEANUP_ALL" = "true" ]; then
            echo "### ⚠️ Complete Cleanup Performed" >> $GITHUB_STEP_SUMMARY
            echo "- **Action:** Deleted ALL snapshot releases" >> $GITHUB_STEP_SUMMARY
            echo "- **Deleted:** $DELETED_COUNT snapshots" >> $GITHUB_STEP_SUMMARY
            echo "- **Kept:** Only official releases (v*.*.*)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### 🔄 Selective Cleanup Performed" >> $GITHUB_STEP_SUMMARY
            echo "- **Action:** Kept $KEEP_COUNT most recent version types" >> $GITHUB_STEP_SUMMARY
            echo "- **Deleted:** $DELETED_COUNT snapshots" >> $GITHUB_STEP_SUMMARY
            echo "- **Kept:** $KEPT_COUNT snapshots" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📋 Current Releases" >> $GITHUB_STEP_SUMMARY
          echo "Check the [Releases page](https://github.com/${{ github.repository }}/releases) to see current releases." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🔄 Automatic Cleanup" >> $GITHUB_STEP_SUMMARY
          echo "- **Snapshot releases:** Automatically keep latest 3 version types" >> $GITHUB_STEP_SUMMARY
          echo "- **Production releases:** Cleanup matching snapshots when released" >> $GITHUB_STEP_SUMMARY
          echo "- **Manual cleanup:** Use this workflow for custom cleanup" >> $GITHUB_STEP_SUMMARY
